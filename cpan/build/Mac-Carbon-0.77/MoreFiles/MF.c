/*
 * This file was generated automatically by xsubpp version 1.9508 from the
 * contents of MF.xs. Do not edit this file, edit MF.xs instead.
 *
 *	ANY CHANGES MADE HERE WILL BE LOST!
 *
 */

#line 1 "MF.xs"
/* $Header: /cvsroot/macperl/perl/macos/ext/Mac/MoreFiles/MF.xs,v 1.7 2005/02/20 05:57:13 pudge Exp $
 *
 *    Copyright (c) 1996 Matthias Neeracher
 *
 *    You may distribute under the terms of the Perl Artistic License,
 *    as specified in the README file.
 *
 * $Log: MF.xs,v $
 * Revision 1.7  2005/02/20 05:57:13  pudge
 * GUSI* memory leaks
 *
 * Revision 1.6  2002/12/12 14:57:52  pudge
 * Update POD and docs
 *
 * Revision 1.5  2002/11/13 02:04:52  pudge
 * Aieeeeee!  Big ol' Carbon update.
 *
 * Revision 1.4  2002/01/23 05:44:42  pudge
 * Update whitespace etc., from Thomas
 *
 * Revision 1.3  2001/01/16 21:18:53  pudge
 * Update for FSpDirectoryCopy in MoreFiles 1.5.  Probably should actually
 * add that parameter as an option in the perl glue.
 *
 * Revision 1.2  2000/09/09 22:18:27  neeri
 * Dynamic libraries compile under 5.6
 *
 * Revision 1.1  2000/08/14 03:39:31  neeri
 * Checked into Sourceforge
 *
 * Revision 1.2  1997/11/18 00:52:46  neeri
 * MacPerl 5.1.5
 *
 * Revision 1.1  1997/04/07 20:50:06  neeri
 * Synchronized with MacPerl 5.1.4a1
 *
 */

#define MAC_CONTEXT

#include "EXTERN.h"
#include "perl.h"
#include "XSUB.h"
#ifndef MACOS_TRADITIONAL
#include "../Carbon.h"
#endif
#include <Types.h>
#include <Memory.h>
#include <Files.h>
#ifdef MACOS_TRADITIONAL
#include <GUSIFileSpec.h>
#endif
#include "MoreFiles.h"
#include "FileCopy.h"
#include "IterateDirectory.h"
#include "DirectoryCopy.h"
#include "MoreDesktopMgr.h"

static SV * newMortalFSSpec(short vRefNum, long dirID, ConstStr255Param name)
{
	FSSpec	spec;
	
	spec.vRefNum 	= vRefNum;
	spec.parID		= dirID;
	memcpy(spec.name, name, *name+1);
	
	return sv_2mortal(MP_GUSIFSp2FullPath(&spec, newSVpvn("", 0)));
}

static SV * gMFProc;

static pascal Boolean MFErrHdlr(	
		OSErr error,
		short failedOperation,
		short srcVRefNum,
		long srcDirID,
		ConstStr255Param srcName,
		short dstVRefNum,
		long dstDirID,
		ConstStr255Param dstName)
{
	if (gMFProc) {
		Boolean 	res;
		dSP;
		ENTER;
		SAVETMPS;
		
		PUSHMARK(sp);
		XPUSHs(sv_2mortal(newSViv(error)));
		XPUSHs(sv_2mortal(newSViv(failedOperation)));
		XPUSHs(newMortalFSSpec(srcVRefNum, srcDirID, srcName));
		XPUSHs(newMortalFSSpec(dstVRefNum, dstDirID, dstName));
		PUTBACK;
		
		perl_call_sv(gMFProc, G_SCALAR);
		
		SPAGAIN;
		
		res = (Boolean) POPi;
		
		PUTBACK;
		FREETMPS;
		LEAVE;
		
		return res;
	} else
		return true;
}

static pascal void MFIterateFilter(const CInfoPBRec * const cpbPtr,
											  Boolean *quitFlag,
											  SV *yourDataPtr)
{
	dSP;
	ENTER;
	SAVETMPS;
	
	PUSHMARK(sp);
	XPUSHs(newMortalFSSpec(
				cpbPtr->hFileInfo.ioVRefNum, 
				cpbPtr->hFileInfo.ioFlParID, 
				cpbPtr->hFileInfo.ioNamePtr));
	XPUSHs(yourDataPtr); 
	PUTBACK;
	
	perl_call_sv(gMFProc, G_SCALAR);
	
	SPAGAIN;
	
	*quitFlag = (Boolean) POPi;
	
	PUTBACK;
	FREETMPS;
	LEAVE;
}

#line 147 "MF.c"
XS(XS_Mac__MoreFiles_FSpCreateMinimum); /* prototype to pass -Wmissing-prototypes */
XS(XS_Mac__MoreFiles_FSpCreateMinimum)
{
    dXSARGS;
    if (items != 1)
	Perl_croak(aTHX_ "Usage: Mac::MoreFiles::FSpCreateMinimum(spec)");
    {
	FSSpec	spec;
	MacOSRet	RETVAL;
	dXSTARG;

	if (GUSIPath2FSp((char *) SvPV_nolen(ST(0)), &spec))
		croak("spec is not a valid file specification");
	else
		0;

	RETVAL = FSpCreateMinimum(&spec);
	XSprePUSH; PUSHi((IV)!(gMacPerl_OSErr = (short)(RETVAL)));
    }
    XSRETURN(1);
}

XS(XS_Mac__MoreFiles_FSpShare); /* prototype to pass -Wmissing-prototypes */
XS(XS_Mac__MoreFiles_FSpShare)
{
    dXSARGS;
    if (items != 1)
	Perl_croak(aTHX_ "Usage: Mac::MoreFiles::FSpShare(spec)");
    {
	FSSpec	spec;
	MacOSRet	RETVAL;
	dXSTARG;

	if (GUSIPath2FSp((char *) SvPV_nolen(ST(0)), &spec))
		croak("spec is not a valid file specification");
	else
		0;

	RETVAL = FSpShare(&spec);
	XSprePUSH; PUSHi((IV)!(gMacPerl_OSErr = (short)(RETVAL)));
    }
    XSRETURN(1);
}

XS(XS_Mac__MoreFiles_FSpUnshare); /* prototype to pass -Wmissing-prototypes */
XS(XS_Mac__MoreFiles_FSpUnshare)
{
    dXSARGS;
    if (items != 1)
	Perl_croak(aTHX_ "Usage: Mac::MoreFiles::FSpUnshare(spec)");
    {
	FSSpec	spec;
	MacOSRet	RETVAL;
	dXSTARG;

	if (GUSIPath2FSp((char *) SvPV_nolen(ST(0)), &spec))
		croak("spec is not a valid file specification");
	else
		0;

	RETVAL = FSpUnshare(&spec);
	XSprePUSH; PUSHi((IV)!(gMacPerl_OSErr = (short)(RETVAL)));
    }
    XSRETURN(1);
}

XS(XS_Mac__MoreFiles_FSpFileCopy); /* prototype to pass -Wmissing-prototypes */
XS(XS_Mac__MoreFiles_FSpFileCopy)
{
    dXSARGS;
    if (items != 4)
	Perl_croak(aTHX_ "Usage: Mac::MoreFiles::FSpFileCopy(srcSpec, dstSpec, copyName, preflight)");
    {
	FSSpec	srcSpec;
	FSSpec	dstSpec;
	Str255	copyName;
	Boolean	preflight = (bool)SvTRUE(ST(3));
	MacOSRet	RETVAL;
	dXSTARG;

	if (GUSIPath2FSp((char *) SvPV_nolen(ST(0)), &srcSpec))
		croak("srcSpec is not a valid file specification");
	else
		0;

	if (GUSIPath2FSp((char *) SvPV_nolen(ST(1)), &dstSpec))
		croak("dstSpec is not a valid file specification");
	else
		0;

	MacPerl_CopyC2P(SvPV_nolen(ST(2)), copyName);
#line 197 "MF.xs"
	RETVAL = FSpFileCopy(&srcSpec, &dstSpec, copyName, nil, 0, preflight);
#line 241 "MF.c"
	XSprePUSH; PUSHi((IV)!(gMacPerl_OSErr = (short)(RETVAL)));
    }
    XSRETURN(1);
}

XS(XS_Mac__MoreFiles_FSpDirectoryCopy); /* prototype to pass -Wmissing-prototypes */
XS(XS_Mac__MoreFiles_FSpDirectoryCopy)
{
    dXSARGS;
    if (items < 3 || items > 4)
	Perl_croak(aTHX_ "Usage: Mac::MoreFiles::FSpDirectoryCopy(srcSpec, dstSpec, preflight, copyErrHandler = NULL)");
    {
	FSSpec	srcSpec;
	FSSpec	dstSpec;
	Boolean	preflight = (bool)SvTRUE(ST(2));
	SV *	copyErrHandler;
	MacOSRet	RETVAL;
	dXSTARG;

	if (GUSIPath2FSp((char *) SvPV_nolen(ST(0)), &srcSpec))
		croak("srcSpec is not a valid file specification");
	else
		0;

	if (GUSIPath2FSp((char *) SvPV_nolen(ST(1)), &dstSpec))
		croak("dstSpec is not a valid file specification");
	else
		0;

	if (items < 4)
	    copyErrHandler = NULL;
	else {
	    copyErrHandler = ST(3);
	}
#line 218 "MF.xs"
	gMFProc = copyErrHandler;
	RETVAL = FSpDirectoryCopy(&srcSpec, &dstSpec, nil, nil, 0, preflight, MFErrHdlr);
#line 279 "MF.c"
	XSprePUSH; PUSHi((IV)!(gMacPerl_OSErr = (short)(RETVAL)));
    }
    XSRETURN(1);
}

XS(XS_Mac__MoreFiles_FSpIterateDirectory); /* prototype to pass -Wmissing-prototypes */
XS(XS_Mac__MoreFiles_FSpIterateDirectory)
{
    dXSARGS;
    if (items != 4)
	Perl_croak(aTHX_ "Usage: Mac::MoreFiles::FSpIterateDirectory(spec, maxLevels, iterateFilter, yourDataPtr)");
    {
	FSSpec	spec;
	unsigned short	maxLevels = (unsigned short)SvUV(ST(1));
	SV *	iterateFilter = ST(2);
	SV *	yourDataPtr = ST(3);
	MacOSRet	RETVAL;
	dXSTARG;

	if (GUSIPath2FSp((char *) SvPV_nolen(ST(0)), &spec))
		croak("spec is not a valid file specification");
	else
		0;
#line 250 "MF.xs"
	gMFProc = iterateFilter;
	RETVAL = FSpIterateDirectory(&spec, maxLevels, (IterateFilterProcPtr)MFIterateFilter, yourDataPtr);
#line 306 "MF.c"
	XSprePUSH; PUSHi((IV)!(gMacPerl_OSErr = (short)(RETVAL)));
    }
    XSRETURN(1);
}

XS(XS_Mac__MoreFiles_FSpDTGetAPPL); /* prototype to pass -Wmissing-prototypes */
XS(XS_Mac__MoreFiles_FSpDTGetAPPL)
{
    dXSARGS;
    if (items != 2)
	Perl_croak(aTHX_ "Usage: Mac::MoreFiles::FSpDTGetAPPL(volume, creator)");
    {
	SV *	volume = ST(0);
	OSType	creator;
#line 271 "MF.xs"
	StringPtr	vName = nil;
	Str63			volName;
	short			vRefNum;
	STRLEN		len;
	char *		vol;
#line 327 "MF.c"
	FSSpec	RETVAL;

	memcpy(&creator, SvPV_nolen(ST(1)), sizeof(OSType));
	creator = ntohl(creator);
#line 277 "MF.xs"
	vol = SvPV(volume, len);
	if (len && vol[len-1] == ':')
		MacPerl_CopyC2P(vol, (vName = volName));
	else
		vRefNum = SvIV(volume);
	if (gMacPerl_OSErr = FSpDTGetAPPL(vName, vRefNum, creator, &RETVAL)) {
		XSRETURN_UNDEF;
	}
#line 341 "MF.c"
	ST(0) = sv_newmortal();
	MP_GUSIFSp2FullPath(&RETVAL, ST(0));
    }
    XSRETURN(1);
}

XS(XS_Mac__MoreFiles_FSpDTSetComment); /* prototype to pass -Wmissing-prototypes */
XS(XS_Mac__MoreFiles_FSpDTSetComment)
{
    dXSARGS;
    if (items != 2)
	Perl_croak(aTHX_ "Usage: Mac::MoreFiles::FSpDTSetComment(spec, comment)");
    {
	FSSpec	spec;
	Str255	comment;
	MacOSRet	RETVAL;
	dXSTARG;

	if (GUSIPath2FSp((char *) SvPV_nolen(ST(0)), &spec))
		croak("spec is not a valid file specification");
	else
		0;

	MacPerl_CopyC2P(SvPV_nolen(ST(1)), comment);

	RETVAL = FSpDTSetComment(&spec, comment);
	XSprePUSH; PUSHi((IV)!(gMacPerl_OSErr = (short)(RETVAL)));
    }
    XSRETURN(1);
}

XS(XS_Mac__MoreFiles_FSpDTGetComment); /* prototype to pass -Wmissing-prototypes */
XS(XS_Mac__MoreFiles_FSpDTGetComment)
{
    dXSARGS;
    if (items != 1)
	Perl_croak(aTHX_ "Usage: Mac::MoreFiles::FSpDTGetComment(spec)");
    {
	FSSpec	spec;
	Str255	RETVAL;
	dXSTARG;

	if (GUSIPath2FSp((char *) SvPV_nolen(ST(0)), &spec))
		croak("spec is not a valid file specification");
	else
		0;
#line 312 "MF.xs"
	if (gMacPerl_OSErr = FSpDTGetComment(&spec, RETVAL)) {
		XSRETURN_UNDEF;
	}
#line 392 "MF.c"
	XSprePUSH; PUSHp(((char *) RETVAL) + 1, RETVAL[0]);
    }
    XSRETURN(1);
}

XS(XS_Mac__MoreFiles_FSpDTCopyComment); /* prototype to pass -Wmissing-prototypes */
XS(XS_Mac__MoreFiles_FSpDTCopyComment)
{
    dXSARGS;
    if (items != 2)
	Perl_croak(aTHX_ "Usage: Mac::MoreFiles::FSpDTCopyComment(srcSpec, dstSpec)");
    {
	FSSpec	srcSpec;
	FSSpec	dstSpec;
	MacOSRet	RETVAL;
	dXSTARG;

	if (GUSIPath2FSp((char *) SvPV_nolen(ST(0)), &srcSpec))
		croak("srcSpec is not a valid file specification");
	else
		0;

	if (GUSIPath2FSp((char *) SvPV_nolen(ST(1)), &dstSpec))
		croak("dstSpec is not a valid file specification");
	else
		0;

	RETVAL = FSpDTCopyComment(&srcSpec, &dstSpec);
	XSprePUSH; PUSHi((IV)!(gMacPerl_OSErr = (short)(RETVAL)));
    }
    XSRETURN(1);
}

#ifdef __cplusplus
extern "C"
#endif
XS(boot_Mac__MoreFiles); /* prototype to pass -Wmissing-prototypes */
XS(boot_Mac__MoreFiles)
{
    dXSARGS;
    char* file = __FILE__;

    XS_VERSION_BOOTCHECK ;

        newXS("Mac::MoreFiles::FSpCreateMinimum", XS_Mac__MoreFiles_FSpCreateMinimum, file);
        newXS("Mac::MoreFiles::FSpShare", XS_Mac__MoreFiles_FSpShare, file);
        newXS("Mac::MoreFiles::FSpUnshare", XS_Mac__MoreFiles_FSpUnshare, file);
        newXS("Mac::MoreFiles::FSpFileCopy", XS_Mac__MoreFiles_FSpFileCopy, file);
        newXS("Mac::MoreFiles::FSpDirectoryCopy", XS_Mac__MoreFiles_FSpDirectoryCopy, file);
        newXS("Mac::MoreFiles::FSpIterateDirectory", XS_Mac__MoreFiles_FSpIterateDirectory, file);
        newXS("Mac::MoreFiles::FSpDTGetAPPL", XS_Mac__MoreFiles_FSpDTGetAPPL, file);
        newXS("Mac::MoreFiles::FSpDTSetComment", XS_Mac__MoreFiles_FSpDTSetComment, file);
        newXS("Mac::MoreFiles::FSpDTGetComment", XS_Mac__MoreFiles_FSpDTGetComment, file);
        newXS("Mac::MoreFiles::FSpDTCopyComment", XS_Mac__MoreFiles_FSpDTCopyComment, file);
    XSRETURN_YES;
}

